<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AddaGhor - The Ultimate Social Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Final & Polished CSS --- */
        /* Paste the complete CSS from the previous correct version. */
        /* Add new styles for new features: */
        .profile-header { text-align: center; padding: 20px; }
        .profile-stats { display: flex; justify-content: space-around; margin: 15px 0; }
        .follow-btn { padding: 8px 20px; border-radius: 8px; }
        .chat-input .file-upload-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--light-text); }
        .message-file { background: var(--bg-color); padding: 10px; border-radius: 8px; margin-top: 5px; display: block; text-decoration: none; color: var(--text-color); }
    </style>
</head>
<body>
    <div class="container">
        <!-- SCREENS: loading, login, signup, profile-setup, app -->
        <div id="loading-screen" class="screen active"><!-- ... --></div>
        <div id="login-screen" class.screen></div>
        <!-- ... other screens -->
        <div id="app-screen" class.screen>
            <div class="view-container" id="view-container">
                <!-- Main Sidebar, Profile View, Chat View will be rendered here -->
            </div>
            <nav class="app-nav">
                <button data-view="chats">Chats</button>
                <button data-view="discover">Discover</button>
                <button data-view="profile" data-user-id="self">My Profile</button>
            </nav>
        </div>
    </div>
    <div id="toast"></div>
    <!-- All TEMPLATES (login, signup, profile-setup, and NEW ones for app views) -->
<script>
window.app = {
    // --- CONFIG, STATE, DOM ---
    _supabase: null,
    state: { currentUser: null, currentChat: {}, onlineUsers: new Set(), subscriptions: {} },
    dom: {}, // Cache DOM elements

    // --- INITIALIZATION ---
    init() {
        // ... (Supabase client init)
        this.cacheDom();
        this.initEventListeners();
        this._supabase.auth.onAuthStateChange(this.handleAuthStateChange.bind(this));
    },

    // --- AUTH FLOW (same as the last final version) ---
    async handleAuthStateChange(_, session) { /* ... */ },
    
    // --- UI RENDERING & NAVIGATION ---
    navigateTo(view, context = {}) {
        // This function will render different views (chats, profile, discover) inside the app-screen
        let template;
        switch(view) {
            case 'profile':
                this.renderProfileView(context.userId);
                break;
            // ... other cases
        }
    },
    
    async renderProfileView(userId) {
        const targetUserId = userId === 'self' ? this.state.currentUser.id : userId;
        // Fetch profile data, follower/following counts, and check if current user is following
        const { data: profile, error } = await this._supabase.from('profiles').select('*, followers:follower_id(count), following:following_id(count)').eq('id', targetUserId).single();
        // ... Render the profile HTML using a template
    },
    
    // --- FEATURE: FOLLOW SYSTEM ---
    async handleFollow(targetUserId) {
        const isFollowing = /* check if already following */;
        if (isFollowing) {
            await this._supabase.from('followers').delete().match({ follower_id: this.state.currentUser.id, following_id: targetUserId });
        } else {
            await this._supabase.from('followers').insert({ follower_id: this.state.currentUser.id, following_id: targetUserId });
        }
        this.renderProfileView(targetUserId); // Re-render to update button and counts
    },

    // --- FEATURE: FILE SHARING ---
    async handleFileUpload(file) {
        if (!file || !this.state.currentChat.id) return;
        
        // 1. Create a placeholder message to get a message ID
        const { data: msg, error: msgError } = await this._supabase.from('messages').insert({
            sender_id: this.state.currentUser.id,
            [this.state.currentChat.type === 'dm' ? 'receiver_id' : 'channel_id']: this.state.currentChat.id,
            content: `Uploading ${file.name}...` // Placeholder content
        }).select().single();

        if (msgError) return this.showToast('Could not create message', 'error');

        // 2. Upload the file to Storage with the message ID in the path
        const filePath = `${msg.id}/${file.name}`;
        const { error: uploadError } = await this._supabase.storage.from('shared-files').upload(filePath, file);

        if (uploadError) {
             await this._supabase.from('messages').delete().eq('id', msg.id); // Rollback
             return this.showToast('File upload failed', 'error');
        }

        // 3. Get the public (or signed) URL and update the message
        const { data: urlData } = this._supabase.storage.from('shared-files').getPublicUrl(filePath);
        await this._supabase.from('messages').update({
            content: null, // Remove placeholder text
            file_url: urlData.publicUrl,
            file_metadata: { name: file.name, size: file.size, type: file.type }
        }).eq('id', msg.id);
    },

    // --- FEATURE: VANISH MODE & ACTIVE STATUS (same as previous final versions) ---
    // ...

    // --- GLOBAL EVENT HANDLER & APP INITIALIZATION ---
    initEventListeners() {
        this.dom.container.addEventListener('click', this.handleGlobalClick.bind(this));
        // Add listener for file input change
        this.dom.container.addEventListener('change', e => {
            if (e.target.id === 'chat-file-input') {
                this.handleFileUpload(e.target.files[0]);
            }
        });
    },

    async initializeApp(user) {
        const { data } = await this._supabase.from('profiles').select('*').eq('id', user.id).single();
        this.state.currentUser = data;
        
        // Setup Presence & other realtime subscriptions
        
        this.navigateTo('chats'); // Navigate to the default chats view
        this.showScreen('app');
    },

    handleGlobalClick(e) {
        // ... handle all clicks, including new follow buttons, nav buttons, etc.
        const followUserId = e.target.dataset.followUser;
        if (followUserId) this.handleFollow(followUserId);
    }
};

window.app.init();
</script>
</body>
</html>
