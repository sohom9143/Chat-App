<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AddaGhor - Complete Chat Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #5E5DF0; --bg-color: #F7F8FC; --card-bg: #FFFFFF; --text-color: #1A1A1A;
            --light-text: #8A94A6; --border-color: #E8EAF0; --success-color: #34D399; --error-color: #F87171;
            --online-color: #34D399; --font-family: 'Inter', sans-serif; --shadow: 0 8px 24px rgba(94, 93, 240, 0.1);
            --message-sent-bg: #5E5DF0; --message-received-bg: #E9EAF0;
        }
        *, *::before, *::after { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; }
        body { font-family: var(--font-family); background-color: var(--bg-color); display: flex; justify-content: center; align-items: center; color: var(--text-color); }
        .container { width: 100%; height: 100%; max-width: 420px; background: var(--card-bg); box-shadow: 0 16px 40px rgba(0,0,0,0.1); border-radius: 24px; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; visibility: hidden; transition: opacity 0.4s ease; display: flex; flex-direction: column; }
        .screen.active { opacity: 1; visibility: visible; }
        #loading-screen { justify-content: center; align-items: center; }
        .loader { width: 50px; height: 50px; border: 4px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* --- AUTH & MODAL STYLES --- */
        #auth-screen, .modal-overlay { justify-content: center; padding: 25px; background: rgba(0,0,0,0.4); animation: fadeIn 0.3s; }
        .auth-container, .modal-content { width: 100%; max-width: 380px; text-align: center; background: var(--card-bg); padding: 25px; border-radius: 16px; animation: fadeInUp 0.4s; }
        .input-group { margin-bottom: 16px; }
        .input-group input { width: 100%; padding: 14px; background-color: #F7F7F7; border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px; }
        .auth-btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; color: white; background: var(--primary-color); }
        .auth-btn.magic { background: none; border: 1px solid var(--primary-color); color: var(--primary-color); margin-top: 10px; }
        .form-toggle-link { margin-top: 25px; cursor: pointer; color: var(--primary-color); font-weight: 500; }
        
        /* --- APP LAYOUT & VIEWS --- */
        #app-screen { transform: none; height: 100%; }
        .app-main-view { display: flex; flex-grow: 1; overflow: hidden; position: relative; }
        .view { position: absolute; top: 0; height: 100%; width: 100%; transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; background: var(--card-bg); }
        .sidebar { left: 0; z-index: 2; }
        .chat-view { left: 100%; z-index: 3; }
        .app-main-view.chat-active .sidebar { transform: translateX(-30%); }
        .app-main-view.chat-active .chat-view { transform: translateX(-100%); }
        
        .header { padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .header .back-btn { background: none; border: none; cursor: pointer; padding: 0; font-size: 24px; }
        .sidebar-nav { display: flex; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .sidebar-nav button { flex: 1; background: none; border: none; padding: 12px; cursor: pointer; font-weight: 500; }
        .sidebar-nav button.active { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); }
        .list-container { flex-grow: 1; overflow-y: auto; }
        .list-content.hidden { display: none; }
        
        .list-item { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .list-item:hover { background-color: var(--bg-color); }
        .avatar { position: relative; }
        .avatar img { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; }
        .online-indicator { width: 12px; height: 12px; background-color: var(--online-color); border: 2px solid white; border-radius: 50%; position: absolute; bottom: 2px; right: 10px; }
        .list-item .info { flex-grow: 1; }
        .list-item .info small { color: var(--light-text); }
        .channel-item::before { content: '#'; color: var(--light-text); font-weight: 700; margin-right: 10px; }
        
        /* --- CHAT VIEW STYLES --- */
        #chat-header-info small { font-size: 12px; }
        .vanish-mode-toggle { margin-left: auto; font-size: 24px; cursor: pointer; }
        .vanish-mode-toggle.active { color: var(--primary-color); }
        #chat-messages { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .message-bubble { max-width: 75%; padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; }
        .message-bubble.sent { background-color: var(--message-sent-bg); color: white; align-self: flex-end; }
        .message-bubble.received { background-color: var(--message-received-bg); color: var(--text-color); align-self: flex-start; }
        .message-bubble.vanish { opacity: 0.7; border: 1px dashed var(--light-text); }
        
        .chat-input { padding: 10px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; }
        #message-input { flex-grow: 1; border: none; background: var(--bg-color); padding: 12px; border-radius: 25px; }
        #send-message-btn { background: var(--primary-color); border: none; color: white; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; }

        /* --- Toast Notification --- */
        #toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 25px; border-radius: 25px; z-index: 1000; transition: bottom 0.5s; }
        #toast.show { bottom: 80px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- SCREENS -->
        <div id="loading-screen" class="screen active"><div class="loader"></div></div>
        <div id="auth-screen" class="screen"></div>
        <div id="app-screen" class="screen">
            <div class="app-main-view" id="app-main-view">
                <div class="sidebar view">
                    <div class="header" id="sidebar-header">
                        <button class="back-btn" id="back-to-main-sidebar-btn" style="display: none;">&larr;</button>
                        <h2 id="sidebar-title">Chats</h2>
                    </div>
                    <div class="sidebar-nav" id="main-sidebar-nav">
                        <button class="active" data-list="dms-list">Direct</button>
                        <button data-list="groups-list">Groups</button>
                    </div>
                    <div class="list-container">
                        <div id="dms-list" class="list-content"></div>
                        <div id="groups-list" class="list-content hidden"></div>
                        <div id="channels-list" class="list-content hidden"></div>
                    </div>
                </div>
                <div class="chat-view view" id="chat-view">
                    <div class="header" id="chat-header">
                        <button class="back-btn" id="back-to-sidebar-btn">&larr;</button>
                        <div class="avatar" id="chat-header-avatar"></div>
                        <div class="info" id="chat-header-info"></div>
                        <span class="vanish-mode-toggle" id="vanish-mode-toggle" title="Vanish Mode">&oslash;</span>
                    </div>
                    <div id="chat-messages"></div>
                    <div class="chat-input">
                        <input type="text" id="message-input" placeholder="Type a message...">
                        <button id="send-message-btn">&rarr;</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODALS -->
        <div id="profile-setup-modal" class="screen modal-overlay"></div>
    </div>
    <div id="toast"></div>

    <!-- TEMPLATES -->
    <template id="auth-template">
        <div class="auth-container">
            <div id="login-form" class="auth-form active">
                <h2>Welcome Back!</h2>
                <div class="input-group"><input type="email" id="login-email" placeholder="Email" required></div>
                <button id="magic-login-btn" class="auth-btn magic">Continue with Magic Link</button>
                <p class="form-toggle-link" onclick="window.toggleAuthForms()">Create a new account</p>
            </div>
            <div id="signup-form" class="auth-form">
                <h2>Join AddaGhor</h2>
                <div class="input-group"><input type="email" id="signup-email" placeholder="Enter your email" required></div>
                <button id="magic-signup-btn" class="auth-btn">Sign Up with Magic Link</button>
                <p class="form-toggle-link" onclick="window.toggleAuthForms()">Already have an account?</p>
            </div>
        </div>
    </template>
    <template id="profile-setup-template">
        <div class="modal-content">
            <h3>Complete Your Profile</h3>
            <div class="input-group"><input type="text" id="setup-fullname" placeholder="Full Name"></div>
            <div class="input-group"><input type="text" id="setup-username" placeholder="Username"></div>
            <button id="complete-profile-btn" class="auth-btn">Save & Continue</button>
        </div>
    </template>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const APP_URL = 'https://sohom9143.github.io/Chat-App/';
    
    if (SUPABASE_URL.includes('YOUR_')) {
        document.body.innerHTML = `<h1>Please configure Supabase credentials in the script tag.</h1>`;
        return;
    }
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- STATE MANAGEMENT ---
    let state = {
        currentUser: null,
        currentChat: { type: null, id: null, name: null },
        onlineUsers: new Set(),
        vanishMode: false,
        subscriptions: {
            presence: null,
            messages: null
        }
    };
    
    const dom = {
        container: document.querySelector('.container'),
        screens: { loading: document.getElementById('loading-screen'), auth: document.getElementById('auth-screen'), app: document.getElementById('app-screen') },
        modals: { profileSetup: document.getElementById('profile-setup-modal') },
        app: {
            mainView: document.getElementById('app-main-view'),
            sidebar: {
                title: document.getElementById('sidebar-title'),
                nav: document.getElementById('main-sidebar-nav'),
                backBtn: document.getElementById('back-to-main-sidebar-btn'),
                lists: { dms: document.getElementById('dms-list'), groups: document.getElementById('groups-list'), channels: document.getElementById('channels-list') }
            },
            chat: {
                view: document.getElementById('chat-view'),
                header: document.getElementById('chat-header'),
                headerAvatar: document.getElementById('chat-header-avatar'),
                headerInfo: document.getElementById('chat-header-info'),
                vanishToggle: document.getElementById('vanish-mode-toggle'),
                messages: document.getElementById('chat-messages'),
                input: document.getElementById('message-input'),
                sendBtn: document.getElementById('send-message-btn')
            }
        },
        toast: document.getElementById('toast')
    };

    // --- UI FUNCTIONS ---
    const showScreen = (name) => { Object.values(dom.screens).forEach(s => s.classList.remove('active')); dom.screens[name].classList.add('active'); };
    const showToast = (message, type = 'success') => {
        dom.toast.textContent = message;
        dom.toast.style.backgroundColor = type === 'error' ? 'var(--error-color)' : 'var(--success-color)';
        dom.toast.classList.add('show');
        setTimeout(() => dom.toast.classList.remove('show'), 3000);
    };
    window.toggleAuthForms = () => { dom.screens.auth.querySelector('#login-form').classList.toggle('active'); dom.screens.auth.querySelector('#signup-form').classList.toggle('active'); };
    
    // --- AUTHENTICATION & PROFILE SETUP ---
    const renderAuthForm = () => { dom.screens.auth.innerHTML = document.getElementById('auth-template').innerHTML; };
    const handleMagicLink = async (emailInputId) => {
        const email = document.getElementById(emailInputId).value;
        if (!email) return showToast('Please enter your email.', 'error');
        const { error } = await _supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: APP_URL } });
        if (error) return showToast(error.message, 'error');
        showToast('Magic link sent! Check your email.');
    };
    const handleProfileSetup = async () => {
        const fullName = document.getElementById('setup-fullname').value;
        const username = document.getElementById('setup-username').value;
        if (!fullName || !username) return showToast('All fields are required.', 'error');

        const { error } = await _supabase.from('profiles').update({ full_name: fullName, username, is_profile_complete: true }).eq('id', state.currentUser.id);
        if (error) return showToast(error.message, 'error');
        dom.modals.profileSetup.classList.remove('active');
        await initApp(state.currentUser);
    };

    // --- REALTIME & PRESENCE ---
    const setupRealtime = () => {
        state.subscriptions.presence = _supabase.channel('online-users')
            .on('presence', { event: 'sync' }, () => {
                const presenceState = state.subscriptions.presence.presenceState();
                state.onlineUsers.clear();
                for (const id in presenceState) {
                    state.onlineUsers.add(presenceState[id][0].user_id);
                }
                updateOnlineIndicators();
            })
            .subscribe(async (status) => {
                if (status === 'SUBSCRIBED') {
                    await state.subscriptions.presence.track({ user_id: state.currentUser.id });
                }
            });
    };
    const subscribeToMessages = () => {
        if (state.subscriptions.messages) state.subscriptions.messages.unsubscribe();
        const { type, id } = state.currentChat;
        if (!type || !id) return;

        const filter = type === 'dm'
            ? `(sender_id=eq.${id},receiver_id=eq.${state.currentUser.id}) or (sender_id=eq.${state.currentUser.id},receiver_id=eq.${id})`
            : `channel_id=eq.${id}`;

        state.subscriptions.messages = _supabase.channel(`messages-for-${id}`)
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter },
                (payload) => renderMessage(payload.new)
            )
            .subscribe();
    };

    // --- DATA RENDERING & UI LOGIC ---
    const updateOnlineIndicators = () => { /* Find all .online-indicator and show/hide based on state.onlineUsers */ };
    const renderMessage = (msg) => {
        const isSent = msg.sender_id === state.currentUser.id;
        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble', isSent ? 'sent' : 'received');
        if(msg.is_vanish_mode) bubble.classList.add('vanish');
        bubble.textContent = msg.content;
        dom.app.chat.messages.prepend(bubble);
    };
    const loadMessages = async () => {
        const { type, id } = state.currentChat;
        const query = type === 'dm'
            ? _supabase.from('messages').select('*').or(`(sender_id.eq.${state.currentUser.id},receiver_id.eq.${id}),(sender_id.eq.${id},receiver_id.eq.${state.currentUser.id})`)
            : _supabase.from('messages').select('*').eq('channel_id', id);

        const { data } = await query.order('created_at', { ascending: false }).limit(50);
        dom.app.chat.messages.innerHTML = '';
        data.forEach(renderMessage);
    };

    // --- APP NAVIGATION & CHAT LOGIC ---
    const openChat = async (target) => {
        state.currentChat = target; // { type, id, name, avatar }
        dom.app.mainView.classList.add('chat-active');
        dom.app.chat.headerAvatar.innerHTML = `<img src="${target.avatar}" alt="${target.name}">`;
        dom.app.chat.headerInfo.innerHTML = `<strong>${target.name}</strong><small>${target.type === 'dm' ? 'Direct Message' : 'Group Channel'}</small>`;
        state.vanishMode = false;
        dom.app.chat.vanishToggle.classList.remove('active');
        dom.app.chat.vanishToggle.style.display = target.type === 'dm' ? 'block' : 'none';
        
        await loadMessages();
        subscribeToMessages();
    };
    const closeChat = async () => {
        if (state.vanishMode) {
             await _supabase.from('messages').delete().eq('is_vanish_mode', true)
                .or(`(sender_id.eq.${state.currentUser.id},receiver_id.eq.${state.currentChat.id}),(sender_id.eq.${state.currentChat.id},receiver_id.eq.${state.currentUser.id})`);
        }
        dom.app.mainView.classList.remove('chat-active');
        if (state.subscriptions.messages) state.subscriptions.messages.unsubscribe();
        state.currentChat = { type: null, id: null };
    };
    const sendMessage = async () => {
        const content = dom.app.chat.input.value.trim();
        if (!content) return;
        
        const message = {
            sender_id: state.currentUser.id,
            content,
            is_vanish_mode: state.currentChat.type === 'dm' && state.vanishMode,
        };
        message[state.currentChat.type === 'dm' ? 'receiver_id' : 'channel_id'] = state.currentChat.id;

        dom.app.chat.input.value = '';
        await _supabase.from('messages').insert(message);
    };

    // --- INITIALIZATION ---
    const initApp = async (user) => {
        const { data } = await _supabase.from('profiles').select('*').eq('id', user.id).single();
        state.currentUser = data;
        // await loadSidebarLists();
        setupRealtime();
        showScreen('app');
    };
    const initEventListeners = () => {
        // Use event delegation for dynamically added elements
        dom.container.addEventListener('click', (e) => {
            if (e.target.id === 'magic-login-btn') handleMagicLink('login-email');
            if (e.target.id === 'magic-signup-btn') handleMagicLink('signup-email');
            if (e.target.id === 'complete-profile-btn') handleProfileSetup();
            if (e.target.id === 'send-message-btn') sendMessage();
            if (e.target.closest('#back-to-sidebar-btn')) closeChat();
            if (e.target.id === 'vanish-mode-toggle') {
                state.vanishMode = !state.vanishMode;
                dom.app.chat.vanishToggle.classList.toggle('active', state.vanishMode);
                showToast(`Vanish mode ${state.vanishMode ? 'enabled' : 'disabled'}`);
            }
        });
    };

    _supabase.auth.onAuthStateChange(async (_, session) => {
        if (session) {
            const { data: profile } = await _supabase.from('profiles').select('is_profile_complete').eq('id', session.user.id).single();
            if (profile && !profile.is_profile_complete) {
                state.currentUser = { id: session.user.id }; // Set temporary user
                dom.modals.profileSetup.innerHTML = document.getElementById('profile-setup-template').innerHTML;
                dom.modals.profileSetup.classList.add('active');
            } else if (profile) {
                await initApp(session.user);
            }
        } else {
            if (state.subscriptions.presence) state.subscriptions.presence.unsubscribe();
            renderAuthForm();
            showScreen('auth');
        }
    });

    initEventListeners();
});
</script>
</body>
</html>
